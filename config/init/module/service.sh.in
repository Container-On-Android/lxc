#!/bin/sh

MODDIR=${0%/*}
PKG_TERMUX=/data/data/com.termux

NET_STATE=""
NET_FUNC=""
GPU_STATE=""
AUD_STATE=""
DAEMON_STATE=""

LXC_DIR="@PREFIXDIR@"
LXC_TMPDIR=$LXC_DIR/tmp
LXC_NET=$LXC_DIR/libexec/lxc/lxc-net
LXC_NET_BUILTIN=$LXC_DIR/libexec/lxc/lxc-net-builtin
LXC_DNSMASQ=$LXC_DIR/bin/dnsmasq

NET_FUNC=""
GPU_FUNC=""
GPU_FUNC_DIR=/storage/emulated/0/lxc

# Init desc
sed -i "s|description=.*|description={}|g" $MODDIR/module.prop

# Setup lxc-tmp
if ! mountpoint -q $LXC_TMPDIR; then
    mkdir -p $LXC_TMPDIR
    mount -t tmpfs tmpfs $LXC_TMPDIR
else
    continue
fi

# Setup Cgroup
if mountpoint -q /sys/fs/cgroup; then
    if mountpoint -q /sys/fs/cgroup/unified > /dev/null 2>&1; then
        umount /sys/fs/cgroup/unified
    fi
    umount /sys/fs/cgroup
    mount -t tmpfs tmpfs /sys/fs/cgroup
    mkdir -p /sys/fs/cgroup/unified
    mount -t cgroup2 cgroup2 -o rw,nosuid,nodev,noexec,relatime /sys/fs/cgroup/unified
else
    mount -t tmpfs tmpfs /sys/fs/cgroup
    mkdir -p /sys/fs/cgroup/unified
    mount -t cgroup2 cgroup2 -o rw,nosuid,nodev,noexec,relatime /sys/fs/cgroup/unified
fi

for subsys in cpu cpuacct memory freezer devices blkio pids cpuset systemd; do
  if ! mountpoint -q /sys/fs/cgroup/$subsys > /dev/null 2>&1; then
    mkdir -p /sys/fs/cgroup/$subsys
    
    if [ $subsys == "systemd" ]; then
        mount -t cgroup -o none,name=$subsys cgroup /sys/fs/cgroup/$subsys
    else
        mount -t cgroup -o rw,nosuid,nodev,noexec,relatime,$subsys cgroup /sys/fs/cgroup/$subsys
    fi
    
    if [ $? -eq 0 ]; then
        echo "$subsys ok"
    else
        echo "$subsys failed"
    fi
  else
    echo "$subsys mounted"
  fi
done

# Start lxc-net
if [ -e $LXC_DNSMASQ ]; then
    $LXC_NET start
    NET_FUNC="full"
else
    $LXC_NET_BUILTIN start
    NET_FUNC="IPv6 disabled, Hotspot conflict."
fi

if [ -e $LXC_TMPDIR/lxc/network_up ]; then
    NET_STATE="lxc-net ✅ ($NET_FUNC)"
else
    NET_STATE="lxc-net ❎"
fi

# Start lxc-gpu
if [ -e $GPU_FUNC_DIR/gpu ]; then
    GPU_FUNC=$(cat $GPU_FUNC_DIR/gpu)
    if [ "$GPU_FUNC" = "termux virgl" ]; then
        GPU_STATE="lxc-gpu ✅ ($GPU_FUNC)"
        cat > $GPU_FUNC_DIR/gpu.conf <<EOF
# This file is generated by LXC-daemon, to use this
# config, you can add "lxc.include = $GPU_FUNC_DIR/gpu.conf"
# in $LXC_DIR/lib/lxc/<name>/config.
# need to run "systemctl mask tmp.mount" in container.
lxc.mount.entry = $PKG_TERMUX/files/usr/tmp tmp tmpfs bind,rw 0 0
EOF
    else
        GPU_STATE="lxc-gpu ✅ (Unsupported $GPU_FUNC)"
    fi
else
    GPU_STATE="lxc-gpu ❎ (not loaded)"
fi

# Start lxc-audio
AUD_STATE="lxc-audio ❎"

DAEMON_STATE="$NET_STATE, $GPU_STATE, $AUD_STATE"

sed -i "s|description={}|description=$DAEMON_STATE|g" $MODDIR/module.prop